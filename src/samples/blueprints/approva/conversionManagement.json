{
    "name": "conversionManagement",
    "description": "Fluxo para gestão de conversão",
    "blueprint_spec": {
        "lanes": [
            {
                "id": "GENERAL",
                "name": "General access",
                "rule": {
                    "$js": "({actor_data, bag}) => (actor_data.claims).includes('conversionManagement')"
                }
            },
            {
                "id": "LIST-READ",
                "name": "List and read claims",
                "rule": {
                    "$js": "({actor_data, bag}) => ((actor_data.claims).includes('conversionManagement') && actor_data.actor_id == bag.actor_id)"
                }
            }
        ],
        "nodes": [
            {
                "id": "START",
                "name": "Start unit CRUD",
                "next": "GET-DEV-CONTRACTS",
                "type": "Start",
                "lane_id": "GENERAL",
                "parameters": {
                    "input_schema": {
                        "type": "object",
                        "required": [
                            "intent",
                            "key"
                        ],
                        "properties": {
                            "id": {
                                "type": "string"
                            },
                            "key": {
                                "type": "string"
                            },
                            "intent": {
                                "type": "string"
                            },
                            "filters": {
                                "type": "object"
                            }
                        }
                    }
                }
            },
            {
                "id": "GET-DEV-CONTRACTS",
                "name": "Get dev contracts",
                "next": "SET-DEV-CONTRACTS-TO-BAG",
                "type": "SystemTask",
                "lane_id": "GENERAL",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/dev_contracts?key=eq.{{bag.key}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203
                    ]
                }
            },
            {
                "id": "SET-DEV-CONTRACTS-TO-BAG",
                "name": "Set task settings to bag",
                "next": "VALIDATE-INPUT",
                "type": "SystemTask",
                "lane_id": "GENERAL",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "data": {
                            "$js": "({bag}) => bag.data ? bag.data : {}"
                        },
                        "schema": {
                            "$ref": "result.data[0].value"
                        },
                        "filters": {
                            "$js": "({bag}) => bag.filters ? bag.filters : {}"
                        },
                        "is_team": {
                            "$js": "({bag}) => bag.is_team ? bag.is_team : false"
                        },
                        "key_url": {
                            "$js": "({bag}) => {return (bag.key).substring(7,(bag.key.length))}"
                        },
                        "actor_id": {
                            "$ref": "actor_data.actor_id"
                        }
                    }
                }
            },
            {
                "id": "VALIDATE-INPUT",
                "name": "Validate input",
                "next": "CHECK-INPUT",
                "type": "SystemTask",
                "lane_id": "GENERAL",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "id": {
                            "$ref": "bag.id"
                        },
                        "key": {
                            "$ref": "bag.key"
                        },
                        "data": {
                            "$ref": "bag.data"
                        },
                        "intent": {
                            "$ref": "bag.intent"
                        },
                        "filters": {
                            "$ref": "bag.filters"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/validate/meta_crud"
                        },
                        "verb": "POST",
                        "headers": {
                            "Prefer": "return=representation",
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203
                    ]
                }
            },
            {
                "id": "CHECK-INPUT",
                "name": "Check input",
                "next": {
                    "VALID": "VERIFY-INTENT",
                    "default": "FINISH-DEV-CONTRACTS",
                    "undefined": "FINISH-DEV-CONTRACTS"
                },
                "type": "Flow",
                "lane_id": "GENERAL",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.data.status"
                        }
                    }
                }
            },
            {
                "id": "VERIFY-INTENT",
                "name": "Verify user intent",
                "next": {
                    "LIST": "LIST-REQUESTS-FOR-KANBAN",
                    "READ": "GET-REQUEST",
                    "default": "NOTIFY-INTENT-NOT-FOUND",
                    "undefined": "NOTIFY-INTENT-NOT-FOUND"
                },
                "type": "Flow",
                "lane_id": "GENERAL",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "bag.intent"
                        }
                    }
                }
            },
            {
                "id": "NOTIFY-INTENT-NOT-FOUND",
                "name": "Notify intent not found",
                "next": "FINISH-INTENT-NOT-FOUND",
                "type": "UserTask",
                "lane_id": "GENERAL",
                "parameters": {
                    "input": {
                        "message": {
                            "$ref": "{{bag.key_url}} intent not found."
                        },
                        "toggleModal": true
                    },
                    "action": "NOTIFY-INTENT-NOT-FOUND",
                    "timeout": 1
                }
            },
            {
                "id": "LIST-REQUESTS-FOR-KANBAN",
                "name": "List requests for kanban",
                "next": "SET-REQUEST-LIST-TO-BAG",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "limit": {
                            "$ref": "bag.filters.limit"
                        },
                        "offset": {
                            "$ref": "bag.filters.offset"
                        },
                        "is_team": {
                            "$ref": "bag.is_team"
                        },
                        "actor_id": {
                            "$ref": "bag.actor_id"
                        },
                        "allowedStatus": {
                            "$ref": "bag.filters.allowedStatus"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/requests_management/list-requests-for-kanban"
                        },
                        "verb": "POST",
                        "headers": {
                            "Prefer": "return=representation",
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203
                    ]
                }
            },
            {
                "id": "SET-REQUEST-LIST-TO-BAG",
                "name": "Set request list to bag",
                "next": "GET-INTERACTION-INFORMATION-BY-REQUEST",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "requests": {
                            "$ref": "result.data"
                        }
                    }
                }
            },
            {
                "id": "GET-INTERACTION-INFORMATION-BY-REQUEST",
                "name": "Get interaction information by request",
                "next": "LIST",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "requests": {
                            "$js": "({bag}) => (bag.requests).map(r => ({id: r.id}))"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.CHAT_API}}}/rpc/message/get-interaction-information-by-request"
                        },
                        "verb": "POST",
                        "headers": {
                            "Prefer": "return=representation",
                            "ContentType": "application/json",
                            "Authorization": {
                                "$mustache": "Bearer {{{environment.JWT_KEY}}}"
                            }
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "LIST",
                "name": "Show units to user",
                "next": "CHECK-TIMEOUT-LIST",
                "type": "UserTask",
                "lane_id": "LIST-READ",
                "parameters": {
                    "input": {
                        "list": {
                            "$ref": "bag.requests"
                        },
                        "limit": {
                            "$ref": "bag.filters.limit"
                        },
                        "offset": {
                            "$ref": "bag.filters.offset"
                        },
                        "list_chat": {
                            "$ref": "result.data"
                        },
                        "activity_schema": {
                            "$ref": "bag.schema.LIST"
                        }
                    },
                    "action": "LIST",
                    "timeout": 3600
                }
            },
            {
                "id": "CHECK-TIMEOUT-LIST",
                "name": "Check timeout",
                "next": {
                    "true": "FINISH-LIST",
                    "default": "SET-NEW-FILTERS-TO-BAG",
                    "undefined": "SET-NEW-FILTERS-TO-BAG"
                },
                "type": "Flow",
                "lane_id": "LIST-READ",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.is_continue"
                        }
                    }
                }
            },
            {
                "id": "SET-NEW-FILTERS-TO-BAG",
                "name": "Set new filters to bag",
                "next": "LIST-REQUESTS-FOR-KANBAN",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "filters": {
                            "$ref": "result.activities[0].data.filters"
                        }
                    }
                }
            },
            {
                "id": "GET-REQUEST",
                "name": "Get request",
                "next": "SET-REQUEST-TO-BAG",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/requests?id=eq.{{bag.id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203
                    ]
                }
            },
            {
                "id": "SET-REQUEST-TO-BAG",
                "name": "Set request to bag",
                "next": "GET-PROFILE-CLIENT",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "request": {
                            "$ref": "result.data[0]"
                        }
                    }
                }
            },
            {
                "id": "GET-PROFILE-CLIENT",
                "name": "Get profile",
                "next": "SET-PROFILE-CLIENT-TO-BAG",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/profiles?id=eq.{{bag.request.buyer_id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203
                    ]
                }
            },
            {
                "id": "SET-PROFILE-CLIENT-TO-BAG",
                "name": "Set profile to bag",
                "next": "GET-PROFILE-REALTOR",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "profile": {
                            "$ref": "result.data[0]"
                        }
                    }
                }
            },
            {
                "id": "GET-PROFILE-REALTOR",
                "name": "Get profile",
                "next": "SET-PROFILE-REALTOR-TO-BAG",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/profiles?id=eq.{{bag.request.realtor}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203
                    ]
                }
            },
            {
                "id": "SET-PROFILE-REALTOR-TO-BAG",
                "name": "Set profile to bag",
                "next": "GET-PROOFS",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "realtor": {
                            "$ref": "result.data[0]"
                        }
                    }
                }
            },
            {
                "id": "GET-PROOFS",
                "name": "Get proofs",
                "next": "SET-PROOFS-TO-BAG",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/requests/{{bag.request.id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203
                    ]
                }
            },
            {
                "id": "SET-PROOFS-TO-BAG",
                "name": "Set proofs to bag",
                "next": "GET-STANDARD-MESSAGES",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "proofs": {
                            "$ref": "result.data.proofs"
                        }
                    }
                }
            },
            {
                "id": "GET-STANDARD-MESSAGES",
                "name": "Get standard messages",
                "next": "SET-STANDARD-MESSAGES-TO-BAG",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.CHAT_POSTGREST}}}/standard_message?twilio_status=eq.APPROVED"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203
                    ]
                }
            },
            {
                "id": "SET-STANDARD-MESSAGES-TO-BAG",
                "name": "Set proofs to bag",
                "next": "SEND-DATA-TO-READ",
                "type": "SystemTask",
                "lane_id": "LIST-READ",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "standard_messages": {
                            "$ref": "result.data"
                        }
                    }
                }
            },
            {
                "id": "SEND-DATA-TO-READ",
                "name": "Send data to read",
                "next": "FINISH-READ",
                "type": "UserTask",
                "lane_id": "LIST-READ",
                "parameters": {
                    "input": {
                        "proofs": {
                            "$ref": "bag.proofs"
                        },
                        "realtor": {
                            "$ref": "bag.realtor"
                        },
                        "request": {
                            "$ref": "bag.request"
                        },
                        "profiles": {
                            "main": {
                                "$js": "({ bag }) => { const title = { name: bag?.request?.metadata?.profiles?.main?.name?.value, email: bag?.request?.metadata?.profiles?.main?.email?.value, phone: bag?.party_number }; return { ...bag?.request?.metadata?.profiles?.main, title }; };"
                            },
                            "second": {
                                "$js": "({ bag }) => { const title = { name: bag?.request?.metadata?.profiles?.second?.name?.value, email: bag?.request?.metadata?.profiles.second?.email?.value }; return { ...bag?.request?.metadata?.profiles?.second, title }; };"
                            }
                        },
                        "card_data": {
                            "date": {
                                "$ref": "bag.profile.created_at"
                            },
                            "name": {
                                "$ref": "bag.profile.name"
                            },
                            "phone": {
                                "$ref": "bag.profile.mobile_phone"
                            }
                        },
                        "ui_schema": {
                            "$ref": "bag.schema.READ.ui_schema"
                        },
                        "activity_schema": {
                            "$ref": "bag.schema.READ.activity_schema"
                        },
                        "standard_messages": {
                            "$ref": "bag.standard_messages"
                        },
                        "additionalProperties": false
                    },
                    "action": "READ",
                    "timeout": 3600
                }
            },
            {
                "id": "FINISH-LIST",
                "name": "Finish conversionManagement",
                "next": null,
                "type": "Finish",
                "lane_id": "LIST-READ"
            },
            {
                "id": "FINISH-READ",
                "name": "Finish conversionManagement",
                "next": null,
                "type": "Finish",
                "lane_id": "LIST-READ"
            },
            {
                "id": "FINISH-DEV-CONTRACTS",
                "name": "Finish conversionManagement",
                "next": null,
                "type": "Finish",
                "lane_id": "GENERAL"
            },
            {
                "id": "FINISH-INTENT-NOT-FOUND",
                "name": "Finish conversionManagement",
                "next": null,
                "type": "Finish",
                "lane_id": "GENERAL"
            }
        ],
        "prepare": [],
        "environment": {
            "XPTO": "BOTAUTHOR",
            "JWT_KEY": "JWT_KEY_BP",
            "CHAT_API": "CHAT_API",
            "POSTGREST": "POSTGREST",
            "SERVICE_API": "SERVICE_API",
            "CHAT_POSTGREST": "CHAT_POSTGREST"
        },
        "requirements": [
            "core"
        ]
    }
}