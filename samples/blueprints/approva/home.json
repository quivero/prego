{
    "name": "home",
    "description": "Fluxo de home do usuário",
    "blueprint_spec": {
        "lanes": [
            {
                "id": "L",
                "name": "LoggedUser",
                "rule": {
                    "$js": "({actor_data})=> actor_data.claims.includes('useApp')"
                }
            },
            {
                "id": "U",
                "name": "Usuario Final",
                "rule": {
                    "$js": "({actor_data, bag})=> bag.actor_id === actor_data.actor_id"
                }
            }
        ],
        "nodes": [
            {
                "id": "SA",
                "name": "Start home workflow ",
                "next": "SB5",
                "type": "Start",
                "lane_id": "L",
                "parameters": {
                    "type": "object",
                    "input_schema": {
                        "required": [
                            "offset",
                            "limit"
                        ],
                        "properties": {
                            "limit": {
                                "type": "integer"
                            },
                            "offset": {
                                "type": "integer"
                            }
                        },
                        "additionalProperties": false
                    }
                }
            },
            {
                "id": "SB5",
                "name": "Set ActorId To Bag",
                "next": "ST1",
                "type": "SystemTask",
                "lane_id": "L",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "actor_id": {
                            "$ref": "actor_data.actor_id"
                        }
                    }
                }
            },
            {
                "id": "ST1",
                "name": "Get user profile",
                "next": "SB1",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/profiles?actor_id=eq.{{actor_data.actor_id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "SB1",
                "name": "Set profile to Bag",
                "next": "ST10",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "profile": {
                            "$ref": "result.data[0]"
                        }
                    }
                }
            },
            {
                "id": "ST10",
                "name": "Get Realtor number",
                "next": "SB6",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "profile_id": {
                            "$ref": "bag.profile.id"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/profiles/realtor"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    }
                }
            },
            {
                "id": "SB6",
                "name": "Set realtor number to Bag",
                "next": "ST2",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "realtor_number": {
                            "$ref": "result.data.realtor_number"
                        }
                    }
                }
            },
            {
                "id": "ST2",
                "name": "Get user home properties",
                "next": "SB3",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/properties_projects?list_type=home&limit={{bag.limit}}&offset={{bag.offset}}&profile_id={{bag.profile.id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "ST2-1",
                "name": "Get user home properties",
                "next": "SB3-1",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/properties_projects?list_type=home&limit={{bag.limit}}&offset={{bag.offset}}&profile_id={{bag.profile.id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "SB3-1",
                "name": "Set properties_projects to Bag",
                "next": "U3",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "properties_projects": {
                            "$ref": "result.data"
                        }
                    }
                }
            },
            {
                "id": "SB3",
                "name": "Set properties_projects to Bag",
                "next": "ST6",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "properties_projects": {
                            "$ref": "result.data"
                        }
                    }
                }
            },
            {
                "id": "ST6",
                "name": "Check access home",
                "next": "U1",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/profiles/access_home_count/{{ bag.profile.mobile_phone }}"
                        },
                        "verb": "PATCH",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        201,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "U1",
                "name": "User action with home",
                "next": "F1",
                "type": "UserTask",
                "lane_id": "U",
                "parameters": {
                    "input": {
                        "profile": {
                            "$ref": "bag.profile"
                        },
                        "realtor_number": {
                            "$ref": "bag.realtor_number"
                        },
                        "activity_schema": {
                            "type": "object",
                            "properties": {
                                "action": {
                                    "type": "string"
                                },
                                "message": {
                                    "type": "string"
                                },
                                "property_project_id": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        },
                        "properties_projects": {
                            "$ref": "bag.properties_projects"
                        }
                    },
                    "action": "PROPERTIES_PROJECTS_LIST",
                    "timeout": 3600
                }
            },
            {
                "id": "F1",
                "name": "Check action",
                "next": {
                    "chat": "SB7",
                    "exit": "E",
                    "like": "SB4",
                    "return": "ST2",
                    "default": "SB2",
                    "details": "ST9",
                    "undefined": "E"
                },
                "type": "Flow",
                "lane_id": "U",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.activities[0].data.action"
                        }
                    }
                }
            },
            {
                "id": "SB7",
                "name": "Set message to bag",
                "next": "ST11",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "message": {
                            "$ref": "result.activities[0].data.message"
                        }
                    }
                }
            },
            {
                "id": "ST11",
                "name": "Get chat",
                "next": "F4",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/chats?request_id=eq.{{bag.profile.current_request_id}}&chat_type=eq.REALTOR"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "F4",
                "name": "Check if chat already exists",
                "next": {
                    "false": "ST12",
                    "default": "SB9"
                },
                "type": "Flow",
                "lane_id": "U",
                "parameters": {
                    "input": {
                        "key": {
                            "$js": "({result}) => (result.data.length == 0) ? false : true"
                        }
                    }
                }
            },
            {
                "id": "ST12",
                "name": "Create Chat",
                "next": "SB8",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "chat_type": "REALTOR",
                        "request_id": {
                            "$ref": "bag.profile.current_request_id"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/chat"
                        },
                        "verb": "POST",
                        "headers": {
                            "Prefer": "return=representation",
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "SB8",
                "name": "Set chat_id to bag",
                "next": "ST13",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "chat_id": {
                            "$ref": "result.data.id"
                        }
                    }
                }
            },
            {
                "id": "SB9",
                "name": "Set chat_id to bag",
                "next": "ST13",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "chat_id": {
                            "$ref": "result.data[0].id"
                        }
                    }
                }
            },
            {
                "id": "ST13",
                "name": "Send Message to Realtor",
                "next": "ST2",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "chat_id": {
                            "$ref": "bag.chat_id"
                        },
                        "message": {
                            "$ref": "bag.message"
                        },
                        "destiny_phone": {
                            "$ref": "bag.realtor_numbers"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/chat"
                        },
                        "verb": "POST",
                        "headers": {
                            "Prefer": "return=representation",
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "ST9",
                "name": "Insert Property Project into History",
                "next": "U3",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "profile_id": {
                            "$ref": "bag.profile.id"
                        },
                        "property_project_id": {
                            "$ref": "result.activities[0].data.property_project_id"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/history"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    }
                }
            },
            {
                "id": "U3",
                "name": "Get Propertie Project details",
                "next": "F3",
                "type": "UserTask",
                "lane_id": "U",
                "parameters": {
                    "input": {
                        "profile": {
                            "$ref": "bag.profile"
                        },
                        "realtor_number": {
                            "$ref": "bag.realtor_number"
                        },
                        "activity_schema": {
                            "type": "object",
                            "properties": {
                                "action": {
                                    "type": "string"
                                },
                                "message": {
                                    "type": "string"
                                },
                                "property_project_id": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        },
                        "properties_projects": {
                            "$ref": "bag.properties_projects"
                        }
                    },
                    "action": "PROPERTY_PROJECT_DETAIL",
                    "timeout": 3600
                }
            },
            {
                "id": "F3",
                "name": "Check action",
                "next": {
                    "chat": "SB7",
                    "like": "SB4-1",
                    "return": "ST2",
                    "default": "E",
                    "undefined": "E"
                },
                "type": "Flow",
                "lane_id": "U",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.activities[0].data.action"
                        }
                    }
                }
            },
            {
                "id": "SB4-1",
                "name": "Set properties_project id to Bag",
                "next": "ST3-1",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "liked_propertie_project": {
                            "$ref": "result.activities[0].data.property_project_id"
                        }
                    }
                }
            },
            {
                "id": "ST3-1",
                "name": "Like propertie_project",
                "next": "ST4-1",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "profile_id": {
                            "$ref": "bag.profile.id"
                        },
                        "properties_projects_id": {
                            "$ref": "bag.liked_propertie_project"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/like"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    }
                }
            },
            {
                "id": "ST4-1",
                "name": "User has a match?",
                "next": "F2-1",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "profile_id": {
                            "$ref": "bag.profile.id"
                        },
                        "property_project_id": {
                            "$ref": "bag.liked_propertie_project"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/match"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "F2-1",
                "name": "Check match result",
                "next": {
                    "true": "ST5-1",
                    "default": "ST2-1"
                },
                "type": "Flow",
                "lane_id": "U",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.data"
                        }
                    }
                }
            },
            {
                "id": "ST5-1",
                "name": "Get match property project",
                "next": "U2-1",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/properties_projects?id=eq.{{bag.liked_propertie_project}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "U2-1",
                "name": "Get Match Information",
                "next": "F1",
                "type": "UserTask",
                "lane_id": "U",
                "parameters": {
                    "input": {
                        "image": "PeopleCelebrating",
                        "title": "Deu match!",
                        "subtitle": "Seu corretor recomenda",
                        "paragraph": "este empreendimento que você gostou!!",
                        "goBackLabel": "Ver mais empreendimentos",
                        "goNextLabel": "Falar com o corretor",
                        "realtor_number": {
                            "$ref": "bag.realtor_number"
                        },
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "action"
                            ],
                            "properties": {
                                "action": {
                                    "type": "string"
                                },
                                "message": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        },
                        "property_project": {
                            "$ref": "result.data[0]"
                        }
                    },
                    "action": "MATCH"
                }
            },
            {
                "id": "SB4",
                "name": "Set properties_project id to Bag",
                "next": "ST3",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "liked_propertie_project": {
                            "$ref": "result.activities[0].data.property_project_id"
                        }
                    }
                }
            },
            {
                "id": "ST3",
                "name": "Like propertie_project",
                "next": "ST4",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "profile_id": {
                            "$ref": "bag.profile.id"
                        },
                        "properties_projects_id": {
                            "$ref": "bag.liked_propertie_project"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/like"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    }
                }
            },
            {
                "id": "ST4",
                "name": "User has a match?",
                "next": "F2",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "profile_id": {
                            "$ref": "bag.profile.id"
                        },
                        "property_project_id": {
                            "$ref": "bag.liked_propertie_project"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/match"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "F2",
                "name": "Check match result",
                "next": {
                    "true": "ST5",
                    "default": "ST2"
                },
                "type": "Flow",
                "lane_id": "U",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.data"
                        }
                    }
                }
            },
            {
                "id": "ST5",
                "name": "Get user profile",
                "next": "U2",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/properties_projects?id=eq.{{bag.liked_propertie_project}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "U2",
                "name": "Get Match Information",
                "next": "F1",
                "type": "UserTask",
                "lane_id": "U",
                "parameters": {
                    "input": {
                        "image": "PeopleCelebrating",
                        "title": "Deu match!",
                        "subtitle": "Seu corretor recomenda",
                        "paragraph": "este empreendimento que você gostou!!",
                        "goBackLabel": "Ver mais empreendimentos",
                        "goNextLabel": "Falar com o corretor",
                        "realtor_number": {
                            "$ref": "bag.realtor_number"
                        },
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "action"
                            ],
                            "properties": {
                                "action": {
                                    "type": "string"
                                },
                                "message": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        },
                        "property_project": {
                            "$ref": "result.data[0]"
                        }
                    },
                    "action": "MATCH"
                }
            },
            {
                "id": "SB2",
                "name": "Set offset to bag",
                "next": "ST2",
                "type": "SystemTask",
                "lane_id": "U",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "offset": {
                            "$js": "({bag}) => bag.offset + bag.limit"
                        }
                    }
                }
            },
            {
                "id": "E",
                "name": "Finish Home",
                "next": null,
                "type": "Finish",
                "lane_id": "U"
            }
        ],
        "prepare": [],
        "environment": {
            "POSTGREST": "POSTGREST",
            "SERVICE_API": "SERVICE_API"
        },
        "requirements": [
            "core"
        ]
    }
}